{% extends 'base.html' %}

{% block content %}

<div class="container my-4">

    <div class="d-flex justify-content-end mb-3">
        <a href="/dashboard/" class="btn btn-outline-danger btn-sm"
           style="font-size: 1.4rem; padding: 2px 10px;">
            ✕
        </a>
    </div>

    <h3 class="fw-bold mb-4" style="color:#1a3d7c;">
        {% if madre %}
            Formulario Clínico: {{ madre.nombre_completo }}
        {% else %}
            Nuevo Formulario Clínico
        {% endif %}
    </h3>


    {% if madre_form.errors %}
    <div class="alert alert-danger shadow-sm">
        <strong>Corrige los siguientes errores:</strong>
        <ul class="mt-2 mb-0">
            {% for field, errors in madre_form.errors.items %}
                {% for error in errors %}
                    <li><strong>{{ field }}:</strong> {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}


    {% if error %}
    <div class="alert alert-danger shadow-sm">{{ error }}</div>
    {% endif %}

    <form method="post">
        {% csrf_token %}

        <div class="card shadow-lg border-0 mb-4" style="border-radius:20px;">
            <div class="card-header text-white fw-bold py-3"
                 style="background: linear-gradient(90deg, #0d6efd, #0a58ca); border-radius:20px 20px 0 0;">
                Datos de la Madre
            </div>

            <div class="card-body">

                {{ madre_form.non_field_errors }}

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Nombre Completo</label>
                        {{ madre_form.nombre_completo }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">RUT</label>
                        {{ madre_form.rut }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Fecha Nacimiento</label>
                        {{ madre_form.fecha_nacimiento }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-2">
                        <label class="form-label fw-semibold">Edad materna</label>
                        {{ madre_form.edad }}
                    </div>
                    <div class="col-md-5">
                        <label class="form-label fw-semibold">Comuna</label>
                        {{ madre_form.comuna }}
                    </div>
                    <div class="col-md-5">
                        <label class="form-label fw-semibold">CESFAM</label>
                        {{ madre_form.cesfam }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-3 form-check mt-4">
                        {{ madre_form.migrante }}
                        <label class="form-check-label ms-1">Migrante</label>
                    </div>

                    <div class="col-md-3 form-check mt-4">
                        {{ madre_form.pueblo_originario }}
                        <label class="form-check-label ms-1">Pueblo originario</label>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-semibold">VIH positivo</label>
                        {{ madre_form.vih_positivo }}
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Profilaxis completa</label>
                        {{ madre_form.profilaxis_completa }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Resultado VDRL</label>
                        {{ madre_form.vdrl_resultado }}
                    </div>
                    <div class="col-md-4 form-check mt-4">
                        {{ madre_form.vdrl_tratamiento }}
                        <label class="form-check-label ms-1">VDRL tratado</label>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Resultado Hepatitis B</label>
                        {{ madre_form.hepatitis_b_resultado }}
                    </div>
                </div>

            </div>
        </div>
        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="chkParto" name="incluir_parto"
                   {% if incluir_parto %}checked{% endif %}>
            <label class="form-check-label fw-semibold ms-1">
                Registrar / Editar datos de Parto
            </label>
        </div>

        <div id="partoSection" class="card shadow-lg border-0 mb-4 {% if not incluir_parto %}d-none{% endif %}"
             style="border-radius:20px;">

            <div class="card-header text-white fw-bold py-3"
                 style="background: linear-gradient(90deg, #198754, #157347); border-radius:20px 20px 0 0;">
                Datos del Parto
            </div>

            <div class="card-body">

                {{ parto_form.non_field_errors }}

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Fecha Parto</label>
                        {{ parto_form.fecha_parto }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Hora Parto</label>
                        {{ parto_form.hora_parto }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Tipo de Parto</label>
                        {{ parto_form.tipo_parto }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-3 form-check">
                        {{ parto_form.ive_causal2 }}
                        <label class="form-check-label ms-1">IVE Causal 2</label>
                    </div>
                    <div class="col-md-3 form-check">
                        {{ parto_form.acompanante_pabellon }}
                        <label class="form-check-label ms-1">Acompañante en pabellón</label>
                    </div>
                    <div class="col-md-3 form-check">
                        {{ parto_form.clampeo_tardio }}
                        <label class="form-check-label ms-1">Clampeo tardío</label>
                    </div>
                    <div class="col-md-3 form-check">
                        {{ parto_form.gases_cordon }}
                        <label class="form-check-label ms-1">Gases cordón</label>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-3 form-check">
                        {{ parto_form.apego_canguro }}
                        <label class="form-check-label ms-1">Apego canguro</label>
                    </div>
                    <div class="col-md-3 form-check">
                        {{ parto_form.apego_tunel }}
                        <label class="form-check-label ms-1">Apego túnel</label>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Profesional responsable</label>
                        {{ parto_form.profesional_responsable }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Edad gestacional (semanas)</label>
                        {{ parto_form.edad_gestacional_semanas }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Edad gestacional (días)</label>
                        {{ parto_form.edad_gestacional_dias }}
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Observaciones</label>
                    {{ parto_form.observaciones }}
                </div>

                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Monitor</label>
                        {{ parto_form.monitor }}
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-semibold">TTC</label>
                        {{ parto_form.ttc }}
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Inducción</label>
                        {{ parto_form.induccion }}
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Alumno (nombre y apellido)</label>
                        {{ parto_form.alumno }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Plan de parto</label>
                        {{ parto_form.plan_parto }}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Alumbramiento rígido</label>
                        {{ parto_form.alumbramiento_rigido }}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Clasificación Robson</label>
                        {{ parto_form.clasificacion_robson }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Acompañante en el parto</label>
                        {{ parto_form.acompanante_parto }}
                    </div>

                    <div class="col-md-8">
                        <label class="form-label fw-semibold">Motivo no acompañado</label>
                        {{ parto_form.motivo_no_acompanado }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Persona acompañante</label>
                        {{ parto_form.persona_acompanante }}
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Acompañante corta cordón</label>
                        {{ parto_form.acompanante_corta_cordon }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Causa de cesárea</label>
                        {{ parto_form.causa_cesarea }}
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Uso sala SAIP</label>
                        {{ parto_form.uso_sala_saip }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Recuerdos</label>
                        {{ parto_form.recuerdos }}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Retira placenta</label>
                        {{ parto_form.retira_placenta }}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Estampado placenta</label>
                        {{ parto_form.estampado_placenta }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Manejo del dolor farmacológico</label>
                        {{ parto_form.manejo_dolor_farmacologico }}
                    </div>
                </div>

            </div>
        </div>




        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="chkRN" name="incluir_rn"
                   {% if incluir_rn %}checked{% endif %}>
            <label class="form-check-label fw-semibold ms-1">
                Registrar / Editar datos del Recién Nacido
            </label>
        </div>


        <div id="rnSection" class="card shadow-lg border-0 mb-4 {% if not incluir_rn %}d-none{% endif %}"
             style="border-radius:20px;">

            <div class="card-header text-dark fw-bold py-3"
                 style="background: linear-gradient(90deg, #ffc107, #e0a800); border-radius:20px 20px 0 0;">
                Datos del Recién Nacido
            </div>

            <div class="card-body">

                {{ rn_form.non_field_errors }}

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Apellido paterno</label>
                        {{ rn_form.apellido_paterno }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Sexo</label>
                        {{ rn_form.sexo }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Peso (g)</label>
                        {{ rn_form.peso }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Talla (cm)</label>
                        {{ rn_form.talla }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Circunferencia craneana (cm)</label>
                        {{ rn_form.circunferencia_craneana }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Destino final</label>
                        {{ rn_form.destino_final }}
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Diagnóstico</label>
                    {{ rn_form.diagnostico }}
                </div>

                <div class="row mb-3">
                    <div class="col-md-4 form-check">
                        {{ rn_form.malformacion_congenita }}
                        <label class="form-check-label ms-1">Malformación congénita</label>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label fw-semibold">Descripción malformación</label>
                        {{ rn_form.descripcion_malformacion }}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">APGAR 1 min</label>
                        {{ rn_form.apgar_1 }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">APGAR 5 min</label>
                        {{ rn_form.apgar_5 }}
                    </div>
                    <div class="col-md-3 form-check">
                        {{ rn_form.reanimacion_basica }}
                        <label class="form-check-label ms-1">Reanimación básica</label>
                    </div>
                    <div class="col-md-3 form-check">
                        {{ rn_form.reanimacion_avanzada }}
                        <label class="form-check-label ms-1">Reanimación avanzada</label>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-3 form-check">
                        {{ rn_form.profilaxis_ocular }}
                        <label class="form-check-label ms-1">Profilaxis ocular</label>
                    </div>
                    <div class="col-md-3 form-check">
                        {{ rn_form.vacuna_hepatitis_b }}
                        <label class="form-check-label ms-1">Vacuna Hepatitis B</label>
                    </div>
                    <div class="col-md-3 form-check">
                        {{ rn_form.vacuna_bcg }}
                        <label class="form-check-label ms-1">Vacuna BCG</label>
                    </div>
                    <div class="col-md-3 form-check">
                        {{ rn_form.profilaxis_completa }}
                        <label class="form-check-label ms-1">Profilaxis completa</label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Profesional que vacuna VHB</label>
                    {{ rn_form.profesional_vacuna_vhb }}
                </div>

                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Semanas gestación</label>
                        {{ rn_form.semanas_gestacion }}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-semibold">Días gestación</label>
                        {{ rn_form.dias_gestacion }}
                    </div>
                    <div class="col-md-3 form-check">
                        {{ rn_form.apego_inmediato }}
                        <label class="form-check-label ms-1">Apego inmediato</label>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">Notas RN</label>
                    {{ rn_form.notas_rn }}
                </div>

            </div>
        </div>



        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="chkBCG" name="incluir_bcg"
                   {% if incluir_bcg %}checked{% endif %}>
            <label class="form-check-label fw-semibold ms-1">
                Registrar Vacuna BCG
            </label>
        </div>

        <div id="bcgSection" class="card shadow-lg border-0 mb-4 {% if not incluir_bcg %}d-none{% endif %}"
             style="border-radius:20px;">

            <div class="card-header text-white fw-bold py-3"
                 style="background: linear-gradient(90deg, #0d6efd, #0a58ca); border-radius:20px 20px 0 0;">
                Registro Vacuna BCG
            </div>

            <div class="card-body">

                {{ bcg_form.non_field_errors }}

                <div class="row mb-4">
                    <div class="col-md-4 form-check mt-4">
                        {{ bcg_form.aplicada }}
                        <label class="form-check-label ms-1">Aplicada</label>
                    </div>

                    <div class="col-md-8">
                        <label class="form-label fw-semibold">Comuna</label>
                        {{ bcg_form.comuna }}
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Reacción adversa</label>
                        {{ bcg_form.reaccion_adversa }}
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Cama / ubicación</label>
                        {{ bcg_form.cama_ubicacion }}
                    </div>
                </div>

                <hr class="my-4">

                <h5 class="fw-bold mb-3" style="color:#1a3d7c;">Datos automáticos del sistema</h5>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Nombre madre</label>
                        <input type="text" class="form-control" value="{{ bcg.nombre_completo_madre }}" disabled>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">RUT madre</label>
                        <input type="text" class="form-control" value="{{ bcg.rut_madre }}" disabled>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Fecha nacimiento madre</label>
                        <input type="text" class="form-control" value="{{ bcg.fecha_nacimiento_madre }}" disabled>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Fecha nacimiento hijo</label>
                        <input type="text" class="form-control" value="{{ bcg.fecha_nacimiento_hijo }}" disabled>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Sexo RN</label>
                        <input type="text" class="form-control" value="{{ bcg.sexo_rn }}" disabled>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Peso RN (g)</label>
                        <input type="text" class="form-control" value="{{ bcg.peso_rn }}" disabled>
                    </div>
                </div>

            </div>
        </div>


        <div class="d-flex justify-content-end gap-2 mb-4">

            <button name="accion" value="guardar_borrador"
                    class="btn btn-secondary btn-lg px-4 shadow-sm" style="border-radius:12px;">
                Guardar borrador
            </button>

            <button name="accion" value="enviar_supervisor"
                    class="btn btn-primary btn-lg px-4 shadow-sm" style="border-radius:12px;">
                Enviar al supervisor
            </button>

        </div>

    </form>
</div>


<script>
    const chkParto = document.getElementById("chkParto");
    const partoSection = document.getElementById("partoSection");
    const chkRN = document.getElementById("chkRN");
    const rnSection = document.getElementById("rnSection");
    const chkBCG = document.getElementById("chkBCG");
    const bcgSection = document.getElementById("bcgSection");

    if (chkParto) {
        chkParto.addEventListener("change", function () {
            partoSection.classList.toggle("d-none", !this.checked);
            if (!this.checked) {
                chkRN.checked = false;
                rnSection.classList.add("d-none");
                chkBCG.checked = false;
                bcgSection.classList.add("d-none");
            }
        });
    }

    if (chkRN) {
        chkRN.addEventListener("change", function () {
            rnSection.classList.toggle("d-none", !this.checked);
            if (this.checked && !chkParto.checked) {
                chkParto.checked = true;
                partoSection.classList.remove("d-none");
            }
            if (!this.checked) {
                chkBCG.checked = false;
                bcgSection.classList.add("d-none");
            }
        });
    }

    if (chkBCG) {
        chkBCG.addEventListener("change", function () {
            bcgSection.classList.toggle("d-none", !this.checked);
            if (this.checked) {
                if (!chkParto.checked) {
                    chkParto.checked = true;
                    partoSection.classList.remove("d-none");
                }
                if (!chkRN.checked) {
                    chkRN.checked = true;
                    rnSection.classList.remove("d-none");
                }
            }
        });
    }
</script>

{% endblock %}
